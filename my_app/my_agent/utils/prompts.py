from langchain_core.prompts import ChatPromptTemplate
from textwrap import dedent





CHOISE_TABLE_PROMPT = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы аналитик данных, который может помочь суммировать таблицы SQL и разбирать вопросы пользователей о базе данных. 
    Дан вопрос и схема базы данных в формате словаря, где ключи — названия таблиц,
    а значения — списки столбцов в формате ["column='название столбца'; type='тип данных'", ...].

    Определи релевантные таблицы. 
    Если вопрос не относится к базе данных или недостаточно информации для ответа на вопрос, установите is_relevant_tables в False.

    Верните JSON с полями:
    - relevant_tables: словарь релевантных таблиц и их колонок
    - is_relevant_tables: True/False  
    - explanation: краткое объяснение (1 предложение)
    
    '''),
    ("human",
    "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\nОпредели релевантные таблицы:")
])





CHOISE_TABLE_AND_COLUMNS_PROMPT = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы аналитик данных, который выбирает релевантные столбцы из уже отобранных релевантных таблиц.
    Дана схема базы данных в формате словаря, где ключи — названия релевантных таблиц,
    а значения — списки всех столбцов в формате ["column='название столбца'; type='тип данных'", ...].

    Задача: выбрать только те столбцы из каждой таблицы, которые нужны для ответа на вопрос пользователя.

    Верните JSON с полями:
    - relevant_tables: словарь релевантных таблиц и их релевантных колонок
    - explanation: почему выбраны именно эти колонки (1 предложение)

    ПРАВИЛА ВЫБОРА:
    1. SELECT: столбцы, упомянутые в вопросе напрямую или для агрегации (SUM, COUNT, AVG)
    2. GROUP BY: категориальные столбцы для группировки
    3. JOIN: ключи для связывания таблиц (id, foreign_key)
    4. WHERE: столбцы для фильтрации по условиям вопроса
    5. ORDER BY: столбцы для сортировки результата

    Пример:
    Вопрос: "Какая выручка по продуктам за 2023 год?"
    Выбор: {'sales': ['product_id', 'quantity', 'price', 'order_date']}
    Объяснение: "Нужны quantity и price для вычисления выручки, product_id для группировки, order_date для фильтрации по году"
    '''),
    ("human",
    "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\nОпредели релевантные столбцы:")
])





VALIDATE_SQL = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы — ИИ-ассистент, который генерирует SQL-запросы на основе вопросов пользователя и схемы базы данных.
    Схема — словарь, где ключи — названия релевантных таблиц, значения — списки релевантных столбцов.
    
    Если предоставлена sql_error_info — это ошибки выполнения предыдущего SQL-запроса. 
    Учтите их при выборе столбцов (исправьте проблемы с типами данных, отсутствующими столбцами и т.д.).

    Сгенерируйте корректный SQL-запрос для ответа на вопрос. Верните структурированный JSON в формате модели ValidSQL:
    - sql_request: валидный SQL-запрос (одной строкой, без форматирования)
    - explanation: краткая логика запроса (1-2 предложения)

    ПРАВИЛА:
    1. ПРОПУСТИТЕ ВСЕ СТРОКИ, ГДЕ ЛЮБОЙ СТОЛБЕЦ = NULL или "N/A" или ""
    2. Все имена таблиц и столбцов в обратных кавычках `table`.`column`
    3. Используйте только столбцы из предоставленной схемы
    4. Группируйте и сортируйте логично для вопроса
    
    ПРАВИЛА ВЫБОРА:
    1. SELECT: столбцы для результата или агрегации (SUM, COUNT, AVG)
    2. GROUP BY: категориальные столбцы
    3. JOIN: ключи для связывания таблиц
    4. WHERE: столбцы для фильтрации
    5. Если sql_error_info содержит ошибки — исключите проблемные столбцы или выберите альтернативы

    Примеры:
    1. Вопрос: "Какой продукт продается лучше всего?"
       sql_request: "SELECT `product_name`, SUM(`quantity`) as total_quantity FROM `sales` WHERE `product_name` IS NOT NULL AND `quantity` IS NOT NULL AND `product_name` != '' AND `quantity` != '' AND `product_name` != 'N/A' AND `quantity` != 'N/A' GROUP BY `product_name` ORDER BY total_quantity DESC LIMIT 1"
       explanation: "Группируем продажи по продукту, суммируем количество, сортируем по убыванию и берем топ-1"

    2. Вопрос: "Общая выручка по продуктам?"
       sql_request: "SELECT `product_name`, SUM(`quantity` * `price`) as total_revenue FROM `sales` WHERE `product_name` IS NOT NULL AND `quantity` IS NOT NULL AND `price` IS NOT NULL AND `product_name` != '' AND `quantity` != '' AND `price` != '' AND `product_name` != 'N/A' AND `quantity` != 'N/A' AND `price` != 'N/A' GROUP BY `product_name` ORDER BY total_revenue DESC"
       explanation: "Вычисляем выручку как quantity*price, группируем по продукту, исключаем некорректные данные"
       
    Пример с ошибкой:
    sql_error_info: "Column 'invalid_col' doesn't exist"
    Выбор: исключить 'invalid_col', выбрать существующие аналоги
    
    '''),
    ("human",
     "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\n===Ошибка SQL (может быть пустой):\n{sql_error_info}\n\n{stop_words}Определи релевантные столбцы:")
])





CHECK_SQL = ChatPromptTemplate.from_messages([
    ("system",
     '''
    Вы — AI-ассистент, который валидирует SQL-запросы по схеме базы данных.
    
    Задача: проверить SQL-запрос на корректность и вернуть структурированный JSON в формате модели CheckSQL:
    - sql_request_is_valid: true/false (синтаксическая корректность + соответствие схеме)
    - explanation: проблемы SQL или подтверждение корректности (1-2 предложения)
    
    ПРОВЕРКИ:
    1. Все таблицы и столбцы существуют в схеме
    2. Имена в обратных кавычках: `table`.`column`
    3. Корректный синтаксис SELECT/GROUP BY/WHERE/JOIN
    4. Логичные агрегации и фильтры
    5. Нет дублирующихся алиасов/имен
    
    Схема: словарь, где ключи - релевантные таблицы, значения - список релевантных столбцов.
    
    Примеры:
    {"sql_request_is_valid": true, "explanation": "Запрос корректен: все столбцы существуют, синтаксис верный"}
    {"sql_request_is_valid": false, "explanation": "Отсутствует столбец 'invalid_col' в таблице 'sales'"}
    '''),
    ("human", 
     "===Схема базы данных:\n{schema}\n\n===Сгенерированный SQL-запрос:\n{sql_query}\n\nПроверьте SQL и верните JSON в формате CheckSQL:")
])






ANSWER = ChatPromptTemplate.from_messages([
    ("system",
     "Вы — ИИ‑ассистент, который форматирует результаты запросов к базе данных в удобочитаемый для человека ответ. Дай вывод по вопросу пользователя на основе результатов запроса. Не давай ответ в формате Markdown. Дай ответ только в одной строке"),
    ("human", "Вопрос пользователя: {question}\n\nРезультаты запроса: {result}\n\nСформатированный ответ:"),
])




