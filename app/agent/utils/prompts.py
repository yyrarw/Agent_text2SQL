from langchain_core.prompts import ChatPromptTemplate





CHOISE_TABLE_PROMPT = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы аналитик данных, который может помочь суммировать таблицы SQL и разбирать вопросы пользователей о базе данных. 
    Дан вопрос и схема базы данных в формате словаря, где ключи — названия таблиц,
    а значения — списки столбцов в формате ["column='название столбца'; type='тип данных'", ...].

    Определи релевантные таблицы. 
    Если вопрос не относится к базе данных или недостаточно информации для ответа на вопрос, установите is_relevant_tables в False.

    Верните JSON с полями:
    - relevant_tables: словарь релевантных таблиц и их колонок
    - is_relevant_tables: True/False  
    - explanation: краткое объяснение (1 предложение)
    
    '''),
    ("human",
    "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\nОпредели релевантные таблицы:")
])





CHOISE_TABLE_AND_COLUMNS_PROMPT = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы аналитик данных, который выбирает релевантные столбцы из уже отобранных релевантных таблиц.
    Дана схема базы данных в формате словаря, где ключи — названия релевантных таблиц,
    а значения — списки всех столбцов в формате ["column='название столбца'; type='тип данных'", ...].
    Также дан пример данных каждой релевантной таблицы - словарь, где ключи - названия релевантных таблиц, а значения - первые 5 строк соответствующей таблицы.

    Задача: выбрать только те столбцы из каждой таблицы, которые нужны для ответа на вопрос пользователя.

    Верните JSON с полями:
    - relevant_tables_with_rel_columns: словарь релевантных таблиц и их релевантных колонок
    - explanation: почему выбраны именно эти колонки (1 предложение)

    ПРАВИЛА ВЫБОРА:
    1. SELECT: столбцы, упомянутые в вопросе напрямую или для агрегации (SUM, COUNT, AVG)
    2. GROUP BY: категориальные столбцы для группировки
    3. JOIN: ключи для связывания таблиц (id, foreign_key)
    4. WHERE: столбцы для фильтрации по условиям вопроса
    5. ORDER BY: столбцы для сортировки результата

    Пример:
    Вопрос: "Какая выручка по продуктам за 2023 год?"
    Выбор: словарь, где ключ - 'sales', а значения - список из 'product_id', 'quantity', 'price', 'order_date'
    Объяснение: "Нужны quantity и price для вычисления выручки, product_id для группировки, order_date для фильтрации по году"
    '''),
    ("human",
    "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\n===Данные таблиц:\n{tables_info}\n\nОпредели релевантные столбцы:")
])





VALIDATE_SQL = ChatPromptTemplate.from_messages([
    ("system", 
     '''
    Вы — ИИ-ассистент, который генерирует SQL-запросы на основе вопросов пользователя и схемы базы данных.
    Схема — словарь, где ключи — названия релевантных таблиц, значения — списки релевантных столбцов.
    Также дан пример данных каждой релевантной таблицы - словарь, где ключи - названия релевантных таблиц, а значения - первые 5 строк соответствующей таблицы.

    
    Если предоставлена sql_error_info — это ошибки выполнения предыдущего SQL-запроса. 
    Учтите их при выборе столбцов (исправьте проблемы с типами данных, отсутствующими столбцами и т.д.).

    Сгенерируйте корректный SQL-запрос для ответа на вопрос. Верните структурированный JSON в формате модели ValidSQL:
    - sql_request: валидный SQL-запрос (одной строкой, без форматирования)
    - explanation: краткая логика запроса (1-2 предложения)

    ПРАВИЛА:
    1. Все имена таблиц и столбцов в обратных кавычках `table`.`column`
    2. Используйте только столбцы из предоставленной схемы
    3. Группируйте и сортируйте логично для вопроса
    4. Используя точно такой же язык и терминологию, как в исходной базе данных, без какого-либо перевода
    
    ПРАВИЛА ВЫБОРА:
    1. SELECT: столбцы для результата или агрегации (SUM, COUNT, AVG)
    2. GROUP BY: категориальные столбцы
    3. JOIN: ключи для связывания таблиц
    4. WHERE: столбцы для фильтрации
    5. Если sql_error_info содержит ошибки — исключите проблемные столбцы или выберите альтернативы

    Примеры:
    1. Вопрос: "Какой продукт продается лучше всего?"
       sql_request: "SELECT `product_name`, SUM(`quantity`) as total_quantity FROM `sales` GROUP BY `product_name` ORDER BY total_quantity DESC LIMIT 1"
       explanation: "Группируем продажи по продукту, суммируем количество, сортируем по убыванию и берем топ-1"

    2. Вопрос: "Общая выручка по продуктам?"
       sql_request: "SELECT `product_name`, SUM(`quantity` * `price`) as total_revenue FROM `sales` GROUP BY `product_name` ORDER BY total_revenue DESC"
       explanation: "Вычисляем выручку как quantity*price, группируем по продукту, исключаем некорректные данные"
       
    Пример с ошибкой:
    sql_error_info: "Column 'invalid_col' doesn't exist"
    Выбор: исключить 'invalid_col', выбрать существующие аналоги
    
    '''),
    ("human",
     "===Схема базы данных:\n{schema}\n\n===Вопрос пользователя:\n{question}\n\n===Ошибка SQL (может быть пустой):\n{sql_error_info}\n\n{stop_words}===Данные таблиц:\n{tables_info}\n\nОпредели релевантные столбцы:")
])


    # 1. ПРОПУСТИТЕ ВСЕ СТРОКИ, ГДЕ ЛЮБОЙ СТОЛБЕЦ РАВЕН NULL или "N/A" или "".


CHECK_SQL = ChatPromptTemplate.from_messages([
    ("system",
     '''
    Вы — AI-ассистент, который валидирует SQL-запросы по схеме базы данных.
    
    Задача: проверить SQL-запрос на корректность и вернуть структурированный JSON в формате модели CheckSQL:
    - sql_request_is_valid: true/false (синтаксическая корректность + соответствие схеме)
    - explanation: проблемы SQL (1-2 предложения)
    
    ПРОВЕРКИ:
    0. Проанализировать ошибку предыдущего запроса
    1. Все таблицы и столбцы существуют в схеме
    2. Имена в обратных кавычках: `table`.`column`
    3. Корректный синтаксис SELECT/GROUP BY/WHERE/JOIN
    4. Логичные агрегации и фильтры
    5. Нет дублирующихся алиасов/имен
    
    Схема: словарь, где ключи - релевантные таблицы, значения - список релевантных столбцов.
    Также дан пример данных каждой релевантной таблицы - словарь, где ключи - названия релевантных таблиц, а значения - первые 5 строк соответствующей таблицы.

    '''),
    ("human", 
     "===Схема базы данных:\n{schema}\n\n===Сгенерированный SQL-запрос:\n{sql_request}\n\n===Ошибка предыдущего запроса:\n{sql_error_info}\n\n===Данные таблиц:\n{tables_info}\n\nПроверьте SQL и верните JSON в формате CheckSQL:")
])






ANSWER = ChatPromptTemplate.from_messages([
    ("system",
     "Вы — ИИ‑ассистент, который форматирует результаты запросов к базе данных в удобочитаемый для человека ответ. Дай вывод по вопросу пользователя на основе результатов запроса. Не давай ответ в формате Markdown. Дай ответ только в одной строке"),
    ("human", "Вопрос пользователя: {question}\n\nРезультаты запроса: {result}\n\nСформатированный ответ:"),
])




